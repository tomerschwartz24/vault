# on-prem to cloud failover
## Overview 

Using the configuration in this folder you can bootstrap a single ec2 instance that will take the place of your onprem vault cluster during a disaster

-----------------------------------------------------------------------------------------------------------------------------------------------------------
## Disclaimer
- You must provide vault restore point 

- This setup assumes you have an onprem vault HA with raft backend configured with TLS.

-----------------------------------------------------------------------------------------------------------------------------------------------------------
##  SSH Access

*the ```ssh_sg_ingress_cidr``` tf var allows you to set the cidr you'd like ssh access to be enabled from, you should set it to your office cidr.*


After you applied the terraform configuration you can access the instance by acquiring the pem and external ip address generated by process:

1. ```terraform output ```  will return the external ip address 

2. ```terraform output private_key_pem > vault.pem``` will create a pem file so you can access the ec2 instance

3. set the relevant permissions : ```sudo chmod 400 vault.pem```

4. ssh to the ec2 instance ```ssh -i vault.pem ec2-user@external_ip```
-----------------------------------------------------------------------------------------------------------------------------------------------------------

# Vault User-Data injection

1. This solution assumes you have the certificates used in your production cluster ready to be bootstrapped into the failover node in order to allow TLS in the failover node.
Its a security risk to bootstrap a none TLS vault (or anything else basically) in the cloud so there's no support for that in this configuration.

2. additionally, the solution uses iam role and policy in order to pull raft snapshots of vault from an s3 bucket within the same AWS account of the failover node bootstrap,
this means you must have a pre-existing mechanism that backups up your prod vault raft snapshots into s3 or alternatively upload it to a bucket manually before initating the failover solution

3. cloud-init example of aquiring the backup : 

```
latest_snapshot=$(aws s3 ls s3://${vault_snapshots_bucket}/  --recursive | sort | tail -n 1 | awk '{print $4}')
aws s3 cp s3://${vault_snapshots_bucket}/$latest_snapshot /tmp
```

set a ```terraform.tfvars``` file with path to your certs and ```api_addr``` and ```vault_snapshots_bucket```  of vault (should match the domain that has been set within the certificate) inject relevant details to the user-data which in turn allow cloud-init to bootstrap the vault node. : 

```vault_api_addr         = "https://vault.mydomain.com:8200"```

```path_to_ca_crt         = "/vault/vault.ca"```

```path_to_crt            = "/vault/vault.crt"```

```path_to_key            = "/vault/vault.key"```   

```vault_snapshots_bucket = "bucket-name"```

